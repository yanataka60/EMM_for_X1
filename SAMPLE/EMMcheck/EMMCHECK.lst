                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.28.0, LST:Full:4
       0003                     INPUTF      EQU 0003H   ;１行入力
       000B                     PRINT       EQU 000BH   ;文字列のプリント
       0013                     ACCPRT      EQU 0013H   ;１文字出力
       001B                     INKEYD      EQU 001BH   ;１文字入力
       04A3                     CR2     EQU 04A3H   ;行の先頭でないなら改行
       04A7                     CR1     EQU 04A7H   ;改行
       04C8                     ACCDIS      EQU 04C8H   ;１文字出力 コントロール・コード表示版
       0FE2                     MONOP       EQU 0FE2H   ;モニタコールドスタート
       1003                     HOTSTA      EQU 1003H   ;モニタホットスタート
       1207                     ACHXPR      EQU 1207H   ;Aレジスタの値を16進数で出力
       1451                     TUPPER      EQU 1451H   ;大文字に変換
       1480                     IPLFCB      EQU 1480H   ;CZ-8CB01
                                ;FNAME      EQU IPLFCB+1
                                ;FSIZE      EQU IPLFCB+18
                                ;SADRS      EQU IPLFCB+20
                                ;EXEAD      EQU IPLFCB+22
                                
                                
000000 14A0                             ORG 14A0H
                                
000000 14A0 111316          10          LD  DE,TITLE            ;'******** EMMCHECK MENU ********'表示
000003 14A3 CD0B00          17          CALL    PRINT
000006 14A6 CDA704          17          CALL    CR1
000009 14A9 CDA704          17  MENU:       CALL    CR1
00000C 14AC 113316          10          LD  DE,EMENU            ;'0)EMM0 1)EMM1 2)EMM2 3)EMM3 ?'表示
00000F 14AF CD0B00          17          CALL    PRINT
000012 14B2 3E01             7          LD  A,01H               ;一文字入力,キー入力待ち
000014 14B4 CD1B00          17          CALL    INKEYD
000017 14B7 327C16          13          LD  (LNAME+3),A         ;EMM0～EMM3の文字を変更
00001A 14BA 329916          13          LD  (MSG1+3),A
00001D 14BD 328116          13          LD  (SNAME+3),A
000020 14C0 32BF16          13          LD  (MSG4+3),A
                                
000023 14C3 FE30             7          CP  '0'             ;EMM0
000025 14C5 2008            12          JR  NZ,EMM1
000027 14C7 21000D          10          LD  HL,0D00H            ;EMM I/Oアドレス 0D00H
00002A 14CA 227716          16          LD  (EMMADRS),HL
00002D 14CD 1822            12          JR  MENUS
00002F 14CF FE31             7  EMM1:       CP  '1'             ;EMM1
000031 14D1 2008            12          JR  NZ,EMM2
000033 14D3 21040D          10          LD  HL,0D04H            ;EMM I/Oアドレス 0D04H
000036 14D6 227716          16          LD  (EMMADRS),HL
000039 14D9 1816            12          JR  MENUS
00003B 14DB FE32             7  EMM2:       CP  '2'             ;EMM2
00003D 14DD 2008            12          JR  NZ,EMM3
00003F 14DF 21080D          10          LD  HL,0D08H            ;EMM I/Oアドレス 0D08H
000042 14E2 227716          16          LD  (EMMADRS),HL
000045 14E5 180A            12          JR  MENUS
000047 14E7 FE33             7  EMM3:       CP  '3'             ;EMM3
000049 14E9 20BE            12          JR  NZ,MENU
00004B 14EB 210C0D          10          LD  HL,0D0CH            ;EMM I/Oアドレス 0D0CH
00004E 14EE 227716          16          LD  (EMMADRS),HL
                                        
       14F1                     MENUS:
000051 14F1 180C            12          JR  LSTART          ;EMMCHECK
                                
000053 14F3 CDA704          17  EXIT:       CALL    CR1
000056 14F6 115116          10          LD  DE,ENDMSG           ;'Run Again:[G 14A0],If not:[IPL RESET]'表示
000059 14F9 CD0B00          17          CALL    PRINT
00005C 14FC C30310          10          JP  HOTSTA
                                
                                ;**************************** EMMCHECK *********************************
       14FF                     LSTART:
00005F 14FF CDA704          17          CALL    CR1
000062 1502 11B516          10          LD  DE,MSG3             ;「FNAME:」を表示する
000065 1505 CD0B00          17          CALL    PRINT
000068 1508 11BB19          10          LD  DE,BUF              ;DOSファイル名を入力
00006B 150B CD0300          17          CALL    INPUTF
00006E 150E DAF314          10          JP  C,EXIT              ;BREAKキーが押されたらキャンセル
000071 1511 11C119          10          LD  DE,BUF+6            ;DOSファイル名をCHECK
000074 1514 1A               7          LD  A,(DE)
000075 1515 FE0D             7  ST1:        CP  0DH             ;入力なしならDefaultの「EMM0」～「EMM3」を採用
000077 1517 285C            12          JR  Z,ST0
000079 1519 FE00             7          CP  00H             ;入力なしならDefaultの「EMM0」～「EMM3」を採用
00007B 151B 2858            12          JR  Z,ST0
00007D 151D FE20             7          CP  ' '             ;SPACEは読み飛ばし
00007F 151F 2003            12          JR  NZ,ST2
000081 1521 13               6          INC DE
000082 1522 18F1            12          JR  ST1
000084 1524 FE2A             7  ST2:        CP  '*'             ;*が入力されたら「*F」処理へ
000086 1526 280A            12          JR  Z,ST3
000088 1528 ED53ED15        20          LD  (ML0+1),DE          ;DOSファイル名が入力されていたらそちらを採用
00008C 152C ED537915        20          LD  (ML1+1),DE
000090 1530 1843            12          JR  ST0
                                
                                ;**************************** アプリケーション内SD-CARD操作処理 **********************
       1532                     ST3:
       1532                     MLHCMD:
000092 1532 13               6          INC DE
000093 1533 13               6          INC DE
                                
       1534                     FC0:        
000094 1534 1A               7          LD  A,(DE)              ;スペース読み飛ばし
000095 1535 FE00             7          CP  00H
000097 1537 2809            12          JR  Z,FC2
000099 1539 13               6          INC DE
00009A 153A FE20             7          CP  20H
00009C 153C 2002            12          JR  NZ,FC1
00009E 153E 18F4            12          JR  FC0
0000A0 1540 1B               6  FC1:        DEC DE
0000A1 1541 1B               6          DEC DE
       1542                     FC2:
                                
0000A2 1542 21B516          10          LD  HL,MSG3               ;行頭に'FNAME:'を付けることでカーソルを移動させリターンで実行できるように
0000A5 1545 010600          10          LD  BC,MSG3END-MSG3
                                ;**** FDLコマンド呼び出し ****
0000A8 1548 CDF517          17          CALL    DIRLIST
0000AB 154B A7               4          AND A          ;00以外ならERROR
0000AC 154C 2003            12          JR  NZ,SERR
                                ;**** ファイルネーム入力へ復帰 ****
0000AE 154E C3FF14          10          JP  LSTART
                                
                                ;******* アプリケーション内SD-CARD操作処理用ERROR処理 **************
       1551                     SERR:
0000B1 1551 FEF0             7          CP  0F0H
0000B3 1553 2005            12          JR  NZ,SERR3
0000B5 1555 110819          10          LD  DE,MSG_F0
0000B8 1558 180F            12          JR  SERRMSG
                                        
0000BA 155A FEF1             7  SERR3:      CP      0F1H
0000BC 155C 2005            12          JR  NZ,SERR99
0000BE 155E 112119          10          LD  DE,MSG_F1
0000C1 1561 1806            12          JR  SERRMSG
                                        
0000C3 1563 CD0712          17  SERR99:     CALL    ACHXPR
0000C6 1566 113A19          10          LD  DE,MSG99
                                        
       1569                     SERRMSG:
0000C9 1569 CD0B00          17          CALL    PRINT
0000CC 156C CDA704          17          CALL    CR1
0000CF 156F C1              10          POP BC
0000D0 1570 D1              10          POP DE
0000D1 1571 E1              10          POP HL
                                ;**** ファイルネーム入力へ復帰 ****
0000D2 1572 C3FF14          10          JP  LSTART
                                
                                ;********************************** EMMLOAD処理本体 ************************************
0000D5 1575 CDA704          17  ST0:        CALL    CR1
0000D8 1578 117916          10  ML1:        LD  DE,LNAME            ;DOSファイル名表示
0000DB 157B CD0B00          17          CALL    PRINT
0000DE 157E 118816          10          LD  DE,MSG0             ;' CHECK START!'表示
0000E1 1581 CD0B00          17          CALL    PRINT
                                
0000E4 1584 CDF215          17          CALL    EMMRESET            ;EMMアドレスリセット
                                
0000E7 1587 218014          10          LD  HL,IPLFCB
0000EA 158A 012000          10          LD  BC,0020H
0000ED 158D CDE115          17          CALL    MLHED               ;DOSファイル名をArduinoに送信してファイルオープン
0000F0 1590 DAF314          10          JP  C,EXIT              ;DOSファイル名のファイルが存在しない等のエラーがあれば中止
                                        
0000F3 1593 0610             7          LD  B,10H               ;SDからのLOADを8000H(32KB)を16回繰り返し
0000F5 1595 0E30             7          LD  C,30H               ;ブロック名として0～Fを便宜的に表示
                                        
0000F7 1597 C5              11  LOP2:       PUSH    BC
0000F8 1598 CD0516          17          CALL    BPRNT
0000FB 159B 11A516          10          LD  DE,MSG2             ;' BLOCK CHECKING'を表示
0000FE 159E CD0B00          17          CALL    PRINT
                                
000101 15A1 210B1A          10          LD  HL,BUFF
000104 15A4 010080          10          LD  BC,8000H
000107 15A7 CD7517          17          CALL    MLDAT               ;Arduinoから1ブロックを読み込み
                                        
00010A 15AA 210B1A          10          LD  HL,BUFF
00010D 15AD 110080          10          LD  DE,8000H
000110 15B0 ED4B7716        20          LD  BC,(EMMADRS)            ;EMM I/Oアドレス設定
       15B4                     LOP1:       
000114 15B4 ED78            12          IN  A,(C)               ;BUFFから8000H(32KB)を1Byteずつ読み込み、EMMへ書き込み
000116 15B6 BE               7          CP  (HL)
000117 15B7 2019            12          JR  NZ,CHECKERR
000119 15B9 23               6          INC HL
00011A 15BA 1B               6          DEC DE
00011B 15BB 7B               4          LD  A,E
00011C 15BC B2               4          OR  D
00011D 15BD 20F5            12          JR  NZ,LOP1             ;32KB分ループ
                                
00011F 15BF C1              10          POP BC
000120 15C0 0C               4          INC C
000121 15C1 10D4            13          DJNZ    LOP2                ;16回ループ
                                        
000123 15C3 CDA704          17          CALL    CR1
000126 15C6 119616          10          LD  DE,MSG1             ;'EMMx CHECK END'を表示
000129 15C9 CD0B00          17          CALL    PRINT
00012C 15CC CDA704          17          CALL    CR1
00012F 15CF C3F314          10          JP  EXIT                ;終了
                                
       15D2                     CHECKERR:
000132 15D2 CDA704          17          CALL    CR1
000135 15D5 11BC16          10          LD  DE,MSG4             ;'EMMx CHECK ERROR!'を表示
000138 15D8 CD0B00          17          CALL    PRINT
00013B 15DB CDA704          17          CALL    CR1
00013E 15DE C3F314          10          JP  EXIT                ;終了
                                
                                ;************************ セットされたDOSファイル名でファイルオープンするためのMLHED処理 **************
       15E1                     MLHED:
000141 15E1 F3               4          DI
000142 15E2 D5              11          PUSH    DE
000143 15E3 C5              11          PUSH    BC
000144 15E4 E5              11          PUSH    HL
000145 15E5 22B519          16          LD  (FCB),HL
000148 15E8 ED43B719        20          LD  (FSIZE),BC
00014C 15EC 117916          10  ML0:        LD  DE,LNAME
00014F 15EF C32D17          10          JP  MLHED2
                                
       15F2                     EMMRESET:
000152 15F2 AF               4          XOR A               ;EMMアドレスリセット
000153 15F3 ED4B7716        20          LD  BC,(EMMADRS)
000157 15F7 ED79            12          OUT (C),A
000159 15F9 03               6          INC BC
00015A 15FA ED79            12          OUT (C),A
00015C 15FC 03               6          INC BC
00015D 15FD ED79            12          OUT (C),A
00015F 15FF 03               6          INC BC
000160 1600 ED437716        20          LD  (EMMADRS),BC
000164 1604 C9              10          RET
                                
       1605                     BPRNT:
000165 1605 CDA704          17          CALL    CR1
000168 1608 79               4          LD  A,C             ;ブロック名としてA～Fを表示するための処理
000169 1609 FE3A             7          CP  3AH
00016B 160B 3802            12          JR  C,ALPHA
00016D 160D C607             7          ADD A,07H
00016F 160F CD1300          17  ALPHA:      CALL    ACCPRT
000172 1612 C9              10          RET
                                
       1613                     TITLE:
000173 1613 2A2A2A2A2A2A2A2A            DB  '******** EMMCHECK MENU ********'
            20454D4D43484543    
            4B204D454E55202A    
            2A2A2A2A2A2A2A      
000192 1632 00                          DB  00H
                                
000193 1633 3029454D4D302031    EMENU:      DB  '0)EMM0 1)EMM1 2)EMM2 3)EMM3 ?'
            29454D4D31203229    
            454D4D3220332945    
            4D4D33203F          
0001B0 1650 00                          DB  00H
                                
0001B1 1651 52756E2041676169    ENDMSG:     DB  'Run Again:[G 14A0],If not:[IPL RESET]'
            6E3A5B4720313441    
            305D2C4966206E6F    
            743A5B49504C2052    
            455345545D          
0001D6 1676 00                          DB  00H
                                
0001D7 1677 000D                EMMADRS:    DW  0D00H
                                
0001D9 1679 454D4D30            LNAME:      DB  'EMM0'
0001DD 167D 00                          DB  00H
       167E                     LNAME_END:
                                
0001DE 167E 454D4D302D534156    SNAME:      DB  'EMM0-SAVE'
            45                  
0001E7 1687 00                          DB  00H
       1688                     SNAME_END:
                                
0001E8 1688 20434845434B2053    MSG0:       DB  ' CHECK START!'
            5441525421          
0001F5 1695 00                          DB  00H
                                
       1696                     MSG1:
0001F6 1696 454D4D3020434845            DB  'EMM0 CHECK END'
            434B20454E44        
000204 16A4 00                          DB  00H
                                
000205 16A5 20424C4F434B2043    MSG2:       DB  ' BLOCK CHECKING'
            4845434B494E47      
000214 16B4 00                          DB  00H
                                        
000215 16B5 464E414D453A        MSG3:       DB  'FNAME:'
       16BB                     MSG3END:
00021B 16BB 00                          DB  00H
                                
       16BC                     MSG4:
00021C 16BC 454D4D3020434845            DB  'EMM0 CHECK ERROR!'
            434B204552524F52    
            21                  
00022D 16CD 00                          DB  00H
                                
                                
                                ;**** 1BYTE受信 ****
                                ;受信DATAをAレジスタにセットしてリターン
       16CE                     RCVBYTE:
00022E 16CE C5              11          PUSH    BC
00022F 16CF CDEC16          17          CALL    F1CHK               ;PORTC BIT7が1になるまでLOOP
000232 16D2 017D00          10          LD  BC,007DH
000235 16D5 ED78            12          IN  A,(C)               ;PORTB -> A
000237 16D7 F5              11          PUSH    AF
000238 16D8 3E05             7          LD  A,05H
00023A 16DA 017F00          10          LD  BC,007FH
00023D 16DD ED79            12          OUT (C),A               ;PORTC BIT2 <- 1
00023F 16DF CDF616          17          CALL    F2CHK               ;PORTC BIT7が0になるまでLOOP
000242 16E2 3E04             7          LD  A,04H
000244 16E4 017F00          10          LD  BC,007FH
000247 16E7 ED79            12          OUT (C),A               ;PORTC BIT2 <- 0
000249 16E9 F1              10          POP     AF
00024A 16EA C1              10          POP BC
00024B 16EB C9              10          RET
                                
                                ;**** BUSYをCHECK(1) ****
                                ; 7EH BIT7が1になるまでLOP
00024C 16EC 017E00          10  F1CHK:      LD  BC,007EH
00024F 16EF ED78            12          IN  A,(C)
000251 16F1 E680             7          AND 80H             ;PORTC BIT7 = 1?
000253 16F3 28F7            12          JR  Z,F1CHK
000255 16F5 C9              10          RET
                                
                                ;**** BUSYをCHECK(0) ****
                                ; 7EH BIT7が0になるまでLOOP
000256 16F6 017E00          10  F2CHK:      LD  BC,007EH
000259 16F9 ED78            12          IN  A,(C)
00025B 16FB E680             7          AND 80H             ;PORTC BIT7 = 0?
00025D 16FD 20F7            12          JR  NZ,F2CHK
00025F 16FF C9              10          RET
                                
                                ;**** 1BYTE送信 ****
                                ;Aレジスタの内容をPORTA下位4BITに4BITずつ送信
       1700                     SNDBYTE:
000260 1700 C5              11          PUSH    BC
000261 1701 F5              11          PUSH    AF
000262 1702 1F               4          RRA
000263 1703 1F               4          RRA
000264 1704 1F               4          RRA
000265 1705 1F               4          RRA
000266 1706 E60F             7          AND 0FH
000268 1708 CD1317          17          CALL    SND4BIT
00026B 170B F1              10          POP AF
00026C 170C E60F             7          AND 0FH
00026E 170E CD1317          17          CALL    SND4BIT
000271 1711 C1              10          POP BC
000272 1712 C9              10          RET
                                
                                ;**** 4BIT送信 ****
                                ;Aレジスタ下位4ビットを送信する
       1713                     SND4BIT:
000273 1713 017C00          10          LD  BC,007CH
000276 1716 ED79            12          OUT (C),A
000278 1718 3E05             7          LD  A,05H
00027A 171A 017F00          10          LD  BC,007FH
00027D 171D ED79            12          OUT (C),A               ;PORTC BIT2 <- 1
00027F 171F CDEC16          17          CALL    F1CHK               ;PORTC BIT7が1になるまでLOOP
000282 1722 3E04             7          LD  A,04H
000284 1724 017F00          10          LD  BC,007FH
000287 1727 ED79            12          OUT (C),A               ;PORTC BIT2 <- 0
000289 1729 CDF616          17          CALL    F2CHK
00028C 172C C9              10          RET
                                        
                                
                                ;************************** MLHED リード インフォメーション代替処理 *****************
                                
00028D 172D 3E93             7  MLHED2:     LD  A,93H               ;HEADER LOADコマンド93H
00028F 172F CDC117          17          CALL    MCMD                ;コマンドコード送信
000292 1732 A7               4          AND A               ;00以外ならERROR
000293 1733 C2CD17          10          JP  NZ,MERR
                                
       1736                     MLH1:
000296 1736 1A               7          LD  A,(DE)
000297 1737 FE20             7          CP  20H             ;行頭のスペースをファイルネームまで読み飛ばし
000299 1739 2003            12          JR  NZ,MLH2
00029B 173B 13               6          INC DE
00029C 173C 18F8            12          JR  MLH1
                                
00029E 173E 0620             7  MLH2:       LD  B,20H
0002A0 1740 1A               7  MLH4:       LD  A,(DE)              ;FNAME送信
0002A1 1741 CD0017          17          CALL    SNDBYTE
0002A4 1744 13               6          INC DE
0002A5 1745 05               4          DEC B
0002A6 1746 20F8            12          JR  NZ,MLH4
0002A8 1748 3E0D             7          LD  A,0DH
0002AA 174A CD0017          17          CALL    SNDBYTE
                                        
0002AD 174D CDCE16          17          CALL    RCVBYTE             ;状態取得(00H=OK)
0002B0 1750 A7               4          AND A               ;00以外ならERROR
0002B1 1751 C2CD17          10          JP  NZ,MERR
                                
0002B4 1754 CDCE16          17          CALL    RCVBYTE             ;状態取得(00H=OK)
0002B7 1757 A7               4          AND A               ;00以外ならERROR
0002B8 1758 C2CD17          10          JP  NZ,MERR
                                
0002BB 175B 2AB519          16          LD  HL,(FCB)
0002BE 175E ED4BB719        20          LD  BC,(FSIZE)
0002C2 1762 41               4          LD  B,C
0002C3 1763 CDCE16          17  MLH5:       CALL    RCVBYTE             ;読みだされたインフォメーションブロックを受信
0002C6 1766 77               7          LD  (HL),A
                                
0002C7 1767 23               6          INC HL
0002C8 1768 05               4          DEC B
0002C9 1769 20F8            12          JR  NZ,MLH5
                                
0002CB 176B CDCE16          17          CALL    RCVBYTE             ;状態取得(00H=OK)
0002CE 176E A7               4          AND A               ;00以外ならERROR
0002CF 176F C2CD17          10          JP  NZ,MERR
                                
0002D2 1772 C3C817          10          JP  MRET                ;正常RETURN
                                
                                ;**************************** MLDAT リード データ代替処理 ********************
       1775                     MLDAT:
0002D5 1775 F3               4          DI
0002D6 1776 D5              11          PUSH    DE
0002D7 1777 C5              11          PUSH    BC
0002D8 1778 E5              11          PUSH    HL
0002D9 1779 22B919          16          LD  (SADRS),HL
0002DC 177C ED43B719        20          LD  (FSIZE),BC
0002E0 1780 3E94             7          LD  A,94H               ;DATA LOADコマンド94H
0002E2 1782 CDC117          17          CALL    MCMD                ;コマンドコード送信
0002E5 1785 A7               4          AND A               ;00以外ならERROR
0002E6 1786 C2CD17          10          JP  NZ,MERR
                                
0002E9 1789 CDCE16          17          CALL    RCVBYTE             ;状態取得(00H=OK)
0002EC 178C A7               4          AND A               ;00以外ならERROR
0002ED 178D C2CD17          10          JP  NZ,MERR
                                
0002F0 1790 CDCE16          17          CALL    RCVBYTE             ;状態取得(00H=OK)
0002F3 1793 A7               4          AND A               ;00以外ならERROR
0002F4 1794 C2CD17          10          JP  NZ,MERR
                                
0002F7 1797 11B719          10          LD  DE,FSIZE            ;FSIZE送信
0002FA 179A 1A               7          LD  A,(DE)
0002FB 179B CD0017          17          CALL    SNDBYTE
0002FE 179E 13               6          INC DE
0002FF 179F 1A               7          LD  A,(DE)
000300 17A0 CD0017          17          CALL    SNDBYTE
000303 17A3 CDAF17          17          CALL    DBRCV2              ;FSIZE分のデータを受信し、SADRSから格納。分割ロードの場合、直前に0436HでOPENされたファイルを対象として256バイトずつSADRSが加算されて04F8HがCALLされる。
                                
000306 17A6 CDCE16          17          CALL    RCVBYTE             ;状態取得(00H=OK)
000309 17A9 A7               4          AND A               ;00以外ならERROR
00030A 17AA C2CD17          10          JP  NZ,MERR
                                
00030D 17AD 1819            12          JR  MRET                ;正常RETURN
                                
                                ;データ受信2
00030F 17AF ED5BB719        20  DBRCV2:     LD  DE,(FSIZE)
000313 17B3 2AB919          16          LD  HL,(SADRS)
000316 17B6 CDCE16          17  DBRLP2:     CALL    RCVBYTE
000319 17B9 77               7          LD  (HL),A
00031A 17BA 1B               6          DEC DE
00031B 17BB 7A               4          LD  A,D
00031C 17BC B3               4          OR  E
00031D 17BD 23               6          INC HL
00031E 17BE 20F6            12          JR  NZ,DBRLP2           ;DE=0までLOOP
000320 17C0 C9              10          RET
                                
                                ;******* 代替処理用コマンドコード送信 (IN:A コマンドコード) **********
       17C1                     MCMD:
000321 17C1 CD0017          17          CALL    SNDBYTE             ;コマンドコード送信
000324 17C4 CDCE16          17          CALL    RCVBYTE             ;状態取得(00H=OK)
000327 17C7 C9              10          RET
                                
                                ;****** 代替処理用正常RETURN処理 **********
000328 17C8 E1              10  MRET:       POP HL
000329 17C9 C1              10          POP BC
00032A 17CA D1              10          POP DE
00032B 17CB AF               4          XOR A               ;正常終了フラグ
                                        
00032C 17CC C9              10          RET
                                
                                ;******* 代替処理用ERROR処理 **************
       17CD                     MERR:
00032D 17CD FEF0             7          CP  0F0H
00032F 17CF 2005            12          JR  NZ,MERR3
000331 17D1 110819          10          LD  DE,MSG_F0
000334 17D4 180F            12          JR  MERRMSG
                                        
000336 17D6 FEF1             7  MERR3:      CP  0F1H
000338 17D8 2005            12          JR  NZ,MERR99
00033A 17DA 112119          10          LD  DE,MSG_F1
00033D 17DD 1806            12          JR  MERRMSG
                                        
00033F 17DF CD0712          17  MERR99:     CALL    ACHXPR
000342 17E2 113A19          10          LD  DE,MSG99
                                        
       17E5                     MERRMSG:
000345 17E5 CD0B00          17          CALL    PRINT
000348 17E8 CDA704          17          CALL    CR1
00034B 17EB E1              10          POP HL
00034C 17EC C1              10          POP BC
00034D 17ED D1              10          POP DE
00034E 17EE 3E02             7          LD  A,02H
000350 17F0 37               4          SCF
                                
000351 17F1 C9              10          RET
                                
       17F2                     DEFDIR:
000352 17F2 2A4C20                      DB  '*L '
       17F5                     DEND:
                                
                                ;**** DIRLIST本体 (HL=行頭に付加する文字列の先頭アドレス BC=行頭に付加する文字列の長さ) ****
                                ;****              戻り値 A=エラーコード ****
       17F5                     DIRLIST:
000355 17F5 3E83             7          LD  A,83H               ;DIRLISTコマンド83Hを送信
000357 17F7 CD4119          17          CALL    STCD                ;コマンドコード送信
00035A 17FA A7               4          AND A               ;00以外ならERROR
00035B 17FB C28418          10          JP  NZ,DLRET
                                        
00035E 17FE C5              11          PUSH    BC
00035F 17FF 0621             7          LD  B,21H
000361 1801 1A               7  STLT1:      LD  A,(DE)
000362 1802 CD5114          17          CALL    TUPPER
000365 1805 CD0017          17  STLT2:      CALL    SNDBYTE             ;比較文字列を送信
000368 1808 13               6          INC DE
000369 1809 10F6            13          DJNZ    STLT1
00036B 180B C1              10          POP BC
       180C                     DL1:
00036C 180C E5              11          PUSH    HL
00036D 180D C5              11          PUSH    BC
00036E 180E 11BB19          10          LD  DE,BUF
000371 1811 EDB0                        LDIR
000373 1813 EB               4          EX  DE,HL
000374 1814 CDCE16          17  DL2:        CALL    RCVBYTE             ;'00H'を受信するまでを一行とする
000377 1817 FE00             7          CP  00H
000379 1819 280C            12          JR  Z,DL3
00037B 181B FEFF             7          CP  0FFH                ;'0FFH'を受信したら終了
00037D 181D 2816            12          JR  Z,DL4
00037F 181F FEFE             7          CP  0FEH                ;'0FEH'を受信したら一時停止して一文字入力待ち
000381 1821 2819            12          JR  Z,DL5
000383 1823 77               7          LD  (HL),A
000384 1824 23               6          INC HL
000385 1825 18ED            12          JR  DL2
000387 1827 77               7  DL3:        LD  (HL),A
000388 1828 11BB19          10          LD  DE,BUF              ;'00H'を受信したら一行分を表示して改行
00038B 182B CD0B00          17          CALL    PRINT
00038E 182E CDA304          17          CALL    CR2
000391 1831 C1              10          POP BC
000392 1832 E1              10          POP HL
000393 1833 18D7            12          JR  DL1
000395 1835 CDCE16          17  DL4:        CALL    RCVBYTE             ;状態取得(00H=OK)
000398 1838 C1              10          POP BC
000399 1839 E1              10          POP HL
00039A 183A 1848            12          JR  DLRET
                                
00039C 183C 11AB18          10  DL5:        LD  DE,MSG_KEY1         ;HIT ANT KEY表示
00039F 183F CD0B00          17          CALL    PRINT
0003A2 1842 3E1E             7          LD  A,01EH
0003A4 1844 CDC804          17          CALL    ACCDIS
0003A7 1847 11C018          10          LD  DE,MSG_KEY2         ;HIT ANT KEY表示
0003AA 184A CD0B00          17          CALL    PRINT
0003AD 184D CDA304          17          CALL    CR2
0003B0 1850 3E01             7  DL6:        LD  A,01H
0003B2 1852 CD1B00          17          CALL    INKEYD              ;1文字入力待ち
0003B5 1855 CD5114          17          CALL    TUPPER
0003B8 1858 FE00             7          CP  00H
0003BA 185A 28F4            12          JR  Z,DL6
0003BC 185C FE03             7          CP  03H             ;SHIFT+BREAKで打ち切り
0003BE 185E 281A            12          JR  Z,DL7
0003C0 1860 FE1B             7          CP  1BH             ;ESCで打ち切り
0003C2 1862 2816            12          JR  Z,DL7
0003C4 1864 FE1E             7          CP  1EH             ;カーソル↑で打ち切り
0003C6 1866 2808            12          JR  Z,DL9
0003C8 1868 FE42             7          CP  42H             ;「B」で前ページ
0003CA 186A 2810            12          JR  Z,DL8
0003CC 186C 3E00             7          LD  A,00H               ;それ以外で継続
0003CE 186E 180C            12          JR  DL8
0003D0 1870 3E1E             7  DL9:        LD  A,01EH              ;カーソル↑で打ち切ったときにカーソル2行上へ
0003D2 1872 CD1300          17          CALL    ACCPRT
0003D5 1875 3E1E             7          LD  A,01EH
0003D7 1877 CD1300          17          CALL    ACCPRT
0003DA 187A 3EFF             7  DL7:        LD  A,0FFH              ;0FFH中断コードを送信
0003DC 187C CD0017          17  DL8:        CALL    SNDBYTE
0003DF 187F CDA304          17          CALL    CR2
0003E2 1882 1890            12          JR  DL2
                                        
       1884                     DLRET:      
0003E4 1884 C9              10          RET
                                        
       1885                     MSG_DNAME:
0003E5 1885 444F532046494C45            DB  'DOS FILE:'
            3A                  
       188E                     MSG_DNAMEEND:
0003EE 188E 20 LEN:28                   DB  '                            '
00040A 18AA 00                          DB  00H
                                        
       18AB                     MSG_KEY1:
00040B 18AB 4E4558543A414E59            DB  'NEXT:ANY BACK:B BRK:'
            204241434B3A4220    
            42524B3A            
00041F 18BF 00                          DB  00H
       18C0                     MSG_KEY2:
000420 18C0 206F722045534320            DB  ' or ESC or SHT+BRK'
            6F72205348542B42    
            524B                
000432 18D2 00                          DB  00H
                                        
       18D3                     MSG_LD:
000433 18D3 4C4F4144494E4720            DB  'LOADING '
00043B 18DB 00                          DB  00H
                                
       18DC                     WRMSG:
00043C 18DC 5752495445494E47            DB  'WRITEING '
            20                  
000445 18E5 00                          DB  00H
                                
       18E6                     MSG_FNAME:
000446 18E6 46494C45204E414D            DB  'FILE NAME FAILED!'
            45204641494C4544    
            21                  
000457 18F7 00                          DB  00H
                                        
       18F8                     MSG_CMD:
000458 18F8 434F4D4D414E4420            DB  'COMMAND FAILED!'
            4641494C454421      
000467 1907 00                          DB  00H
                                        
       1908                     MSG_F0:
000468 1908 53442D4341524420            DB  'SD-CARD INITIALIZE ERROR'
            494E495449414C49    
            5A45204552524F52    
000480 1920 00                          DB  00H
                                        
       1921                     MSG_F1:
000481 1921 4E4F542046494E44            DB  'NOT FIND FILE'
            2046494C45          
00048E 192E 00                          DB  00H
                                        
       192F                     MSG_F3:
00048F 192F 46494C4520455849            DB  'FILE EXIST'
            5354                
000499 1939 00                          DB  00H
                                        
       193A                     MSG99:
00049A 193A 204552524F52                DB  ' ERROR'
0004A0 1940 00                          DB  00H
                                        
                                ;**** コマンド送信 (IN:A コマンドコード)****
0004A1 1941 CD0017          17  STCD:       CALL    SNDBYTE             ;Aレジスタのコマンドコードを送信
0004A4 1944 CDCE16          17          CALL    RCVBYTE             ;状態取得(00H=OK)
0004A7 1947 C9              10          RET
                                
                                ;**** コマンド、ファイル名送信 (IN:A コマンドコード HL:ファイルネームの先頭)****
0004A8 1948 CD5C19          17  STCMD:      CALL    STFN                ;ファイルネーム取得
0004AB 194B E5              11          PUSH    HL
0004AC 194C CD4119          17          CALL    STCD                ;コマンドコード送信
0004AF 194F E1              10          POP HL
0004B0 1950 A7               4          AND A               ;00以外ならERROR
0004B1 1951 C28319          10          JP  NZ,SVER0
0004B4 1954 CD6B19          17          CALL    STFS                ;ファイルネーム送信
0004B7 1957 A7               4          AND A               ;00以外ならERROR
0004B8 1958 C28319          10          JP  NZ,SVER0
0004BB 195B C9              10          RET
                                
                                ;****** FILE NAME 取得 (IN:DE コマンド文字の次の文字 OUT:HL ファイルネームの先頭)*********
0004BC 195C F5              11  STFN:       PUSH    AF
0004BD 195D 13               6  STFN1:      INC DE              ;ファイルネームまでスペース読み飛ばし
0004BE 195E 1A               7          LD  A,(DE)
0004BF 195F FE20             7          CP  20H
0004C1 1961 28FA            12          JR  Z,STFN1
0004C3 1963 FE30             7          CP  30H             ;「0」以上の文字でなければエラーとする
0004C5 1965 DA7E19          10          JP  C,STSV2
0004C8 1968 EB               4          EX  DE,HL
0004C9 1969 F1              10          POP AF
0004CA 196A C9              10          RET
                                
                                ;**** ファイルネーム送信(IN:HL ファイルネームの先頭) ******
0004CB 196B 0620             7  STFS:       LD  B,20H
0004CD 196D 7E               7  STFS1:      LD  A,(HL)              ;FNAME送信
0004CE 196E CD0017          17          CALL    SNDBYTE
0004D1 1971 23               6          INC HL
0004D2 1972 05               4          DEC B
0004D3 1973 20F8            12          JR  NZ,STFS1
0004D5 1975 3E0D             7          LD  A,0DH
0004D7 1977 CD0017          17          CALL    SNDBYTE
0004DA 197A CDCE16          17          CALL    RCVBYTE             ;状態取得(00H=OK)
0004DD 197D C9              10          RET
                                
       197E                     STSV2:                          ;ファイルネームの取得に失敗
0004DE 197E 11E618          10          LD  DE,MSG_FNAME
0004E1 1981 182B            12          JR  ERRMSG
       1983                     SVER0:
0004E3 1983 D1              10          POP DE              ;CALL元STACKを破棄する
       1984                     SVERR:
0004E4 1984 FEF0             7          CP  0F0H
0004E6 1986 2005            12          JR  NZ,ERR3
0004E8 1988 110819          10          LD  DE,MSG_F0           ;SD-CARD INITIALIZE ERROR
0004EB 198B 1821            12          JR  ERRMSG
0004ED 198D FEF1             7  ERR3:       CP  0F1H
0004EF 198F 2005            12          JR  NZ,ERR4
0004F1 1991 112119          10          LD  DE,MSG_F1           ;NOT FIND FILE
0004F4 1994 1818            12          JR  ERRMSG
0004F6 1996 FEF3             7  ERR4:       CP  0F3H
0004F8 1998 2005            12          JR  NZ,ERR5
0004FA 199A 112F19          10          LD  DE,MSG_F3           ;FILE EXIST
0004FD 199D 180F            12          JR  ERRMSG
0004FF 199F FEF4             7  ERR5:       CP  0F4H
000501 19A1 2005            12          JR  NZ,ERR99
000503 19A3 11F818          10          LD  DE,MSG_CMD
000506 19A6 1806            12          JR  ERRMSG
000508 19A8 CD0712          17  ERR99:      CALL    ACHXPR
00050B 19AB 113A19          10          LD  DE,MSG99            ;その他ERROR
00050E 19AE CD0B00          17  ERRMSG:     CALL    PRINT
000511 19B1 CDA304          17          CALL    CR2
000514 19B4 C9              10  MON:        RET
                                
       19B5                     ENT6:
                                
                                
       19B5                     FCB     DS  2
       19B7                     FSIZE       DS  2
       19B9                     SADRS       DS  2
       19BB                     BUF:        DS  80
                                
       1A0B                     BUFF:
       1A0B                             DS  8000H
                                            END
[EOF:EMMCHECK.s:UTF_8]
